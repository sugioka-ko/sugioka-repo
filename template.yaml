AWSTemplateFormatVersion: '2010-09-09'
Description: Serverless application with React, Bedrock, Lambda, API Gateway, and DynamoDB.

Resources:
  CalculatorTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: React-db
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: "/"
      Policies:
        - PolicyName: DynamoDBAndBedrockAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                Resource: !GetAtt CalculatorTable.Arn
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource: "*"
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "arn:aws:logs:*:*:*"

  CalculatorLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: MyCalculatorFunction
      Handler: index.lambda_handler
      Runtime: python3.13
      Timeout: 15
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        ZipFile: |
          import json
          import boto3
          import uuid
          from datetime import datetime
          from zoneinfo import ZoneInfo

          dynamodb = boto3.resource('dynamodb')
          table = dynamodb.Table('React-db')
          bedrock_client = boto3.client(service_name='bedrock-runtime', region_name='ap-northeast-1')

          def call_bedrock(prompt: str) -> str:
              body = json.dumps({
                  "anthropic_version": "bedrock-2023-05-31",
                  "messages": [
                      {"role": "user", "content": [{"type": "text", "text": prompt}]}
                  ],
                  "max_tokens": 100,
                  "temperature": 0.1,
                  "top_p": 0.9
              })
              response = bedrock_client.invoke_model(
                  body=body,
                  modelId="apac.anthropic.claude-3-7-sonnet-20250219-v1:0",
                  accept="application/json",
                  contentType="application/json"
              )
              result = json.loads(response['body'].read())
              return result['content'][0]['text'].strip()

          def lambda_handler(event, context):
              headers = {
                  'Content-Type': 'application/json',
                  'Access-Control-Allow-Origin': '*',
                  'Access-Control-Allow-Headers': 'Content-Type',
                  'Access-Control-Allow-Methods': 'POST,OPTIONS'
              }
              try:
                  if event.get('httpMethod') == 'OPTIONS':
                      return {
                          'statusCode': 200,
                          'headers': headers,
                          'body': json.dumps({})
                      }

                  if not event.get('body'):
                      return {
                          'statusCode': 400,
                          'headers': headers,
                          'body': json.dumps({'error': 'リクエストボディが空です'})
                      }

                  body = json.loads(event['body'])
                  num1 = body.get('num1', 0)
                  num2 = body.get('num2', 0)

                  addition_result = num1 + num2
                  multiplication_result = num1 * num2

                  tokyo_tz = ZoneInfo('Asia/Tokyo')
                  current_time_tokyo = datetime.now(tokyo_tz).isoformat()

                  sum_animal_name = call_bedrock(f"必ず日本語で、体重が約{addition_result}kgの動物の名前を一つだけ答えてください。")
                  product_animal_name = call_bedrock(f"必ず日本語で、体重が約{multiplication_result}kgの動物の名前を一つだけ答えてください。")

                  item_to_save = {
                      'id': f"{current_time_tokyo}_{uuid.uuid4()}",
                      'timestamp': current_time_tokyo,
                      'num1': num1,
                      'num2': num2,
                      'sum': addition_result,
                      'product': multiplication_result,
                      'sum_animal_name': sum_animal_name,
                      'product_animal_name': product_animal_name
                  }
                  table.put_item(Item=item_to_save)

                  results = {
                      "message": "計算が成功しました",
                      "sum": addition_result,
                      "product": multiplication_result,
                      "sum_animal_name": sum_animal_name,
                      "product_animal_name": product_animal_name
                  }

                  return {
                      'statusCode': 200,
                      'headers': headers,
                      'body': json.dumps(results, ensure_ascii=False)
                  }

              except Exception as e:
                  return {
                      'statusCode': 500,
                      'headers': headers,
                      'body': json.dumps({'error': str(e)}, ensure_ascii=False)
                  }

  CalculatorApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: CalculatorApi

  ApiGatewayPostMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref CalculatorApi
      ResourceId: !GetAtt CalculatorApi.RootResourceId
      HttpMethod: POST
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:${AWS::Partition}:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CalculatorLambdaFunction.Arn}/invocations"
      MethodResponses: []

  LambdaApiPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CalculatorLambdaFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${CalculatorApi}/*/POST/"

  ApiGatewayDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - ApiGatewayPostMethod
      - LambdaApiPermission
    Properties:
      RestApiId: !Ref CalculatorApi
      StageName: v1

Outputs:
  ApiUrl:
    Description: URL of the API Gateway
    Value: !Sub "https://${CalculatorApi.RestApiId}.execute-api.${AWS::Region}.amazonaws.com/v1"
